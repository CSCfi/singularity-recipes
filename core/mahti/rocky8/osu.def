Bootstrap: localimage
From: spack-env.sif

%arguments
  NPROCS=4
  OSU_MICRO_BENCHMARKS_VERSION=7.4

%files
    # Spack environment activation script
    activate.sh /opt/activate.sh

%post
  # Install tools
  dnf install -y make gdb wget which

  # Activate Spack environment
  . /opt/activate.sh

  # Build osu benchmarks
  cd /opt
  wget -q http://mvapich.cse.ohio-state.edu/download/mvapich/osu-micro-benchmarks-{{ OSU_MICRO_BENCHMARKS_VERSION }}.tar.gz
  tar xf osu-micro-benchmarks-{{ OSU_MICRO_BENCHMARKS_VERSION }}.tar.gz
  cd osu-micro-benchmarks-{{ OSU_MICRO_BENCHMARKS_VERSION }}
  ./configure --prefix=/opt/osu-micro-benchmarks CC=mpicc CFLAGS=-O3
  make -j{{ NPROCS }}
  make install
  cd ..
  rm -rf osu-micro-benchmarks-{{ OSU_MICRO_BENCHMARKS_VERSION }} osu-micro-benchmarks-{{ OSU_MICRO_BENCHMARKS_VERSION }}.tar.gz

%runscript
  . /opt/activate.sh
  exec "$@"
