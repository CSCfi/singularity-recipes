Bootstrap: localimage
From: spack-env.sif

%arguments
  NPROCS=4
  OSU_MICRO_BENCHMARKS_VERSION=7.4
  GCC_VERSION=15

%post
  # Base tools and newer gcc version
  dnf install -y dnf-plugins-core epel-release
  dnf config-manager --set-enabled powertools
  dnf install -y make gdb wget which
  dnf -y install gcc-toolset-{{ GCC_VERSION }}
  source /opt/rh/gcc-toolset-{{ GCC_VERSION }}/enable

  #export PATH=/scratch/project_2014802/test/v1.1.0/core/gcc152_env/install_dir/linux-zen/gcc-15.2.0-ltdttrgucveu6c2t4hzivgpxpllalwkc/bin

  # OpenMPI
  export PATH=/scratch/project_2014802/test/v1.1.0/core/gcc152_env/install_dir/linux-zen2/openmpi-5.0.8-da6bh56oy5z6ondmabdknyf4deobjbqo/bin:$PATH

  # Build osu benchmarks
  cd /opt
  wget -q http://mvapich.cse.ohio-state.edu/download/mvapich/osu-micro-benchmarks-{{ OSU_MICRO_BENCHMARKS_VERSION }}.tar.gz
  tar xf osu-micro-benchmarks-{{ OSU_MICRO_BENCHMARKS_VERSION }}.tar.gz
  cd osu-micro-benchmarks-{{ OSU_MICRO_BENCHMARKS_VERSION }}
  ./configure --prefix=/opt/osu-micro-benchmarks CC=mpicc CFLAGS=-O3  #|| cat config.log
  make -j{{ NPROCS }}
  make install
  cd ..
  rm -rf osu-micro-benchmarks-{{ OSU_MICRO_BENCHMARKS_VERSION }} osu-micro-benchmarks-{{ OSU_MICRO_BENCHMARKS_VERSION }}.tar.gz

%runscript
  /opt/osu-micro-benchmarks/libexec/osu-micro-benchmarks/mpi/pt2pt/osu_bw
