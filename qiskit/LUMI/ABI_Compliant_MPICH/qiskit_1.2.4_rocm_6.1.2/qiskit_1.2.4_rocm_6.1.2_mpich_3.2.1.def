Bootstrap: docker
From: rocm/dev-ubuntu-22.04:6.1.2-complete

%labels
  Author Michael Mucciardi <michael.mucciardi@csc.fi>

%files
  requirements_qiskit_1.2.4_v9.txt /opt/requirements.txt
  requirements-dev_qiskit_1.2.4_v9.txt /opt/requirements-dev.txt

%post
  # Use all available cores for compilation
  export MAKEFLAGS="-j$(nproc)"

  # Some useful environment variables
  export DEBIAN_FRONTEND=noninteractive
  export LC_ALL=C

  # Update packages
  apt update
  apt upgrade -y

  # g++ gcc gfortran make gdb strace wget ca-certificates --no-install-recommends is recommended on lumi docs for building singularity containers
  apt install -y cmake python-is-python3 git autoconf python3-dev wget git vim \
      libtool openjdk-8-jdk-headless xvfb python3-opengl libaio-dev \
      libxslt1-dev libxml2-dev imagemagick libsndfile1 graphviz \
      libturbojpeg0-dev libxkbcommon-x11-0 libopenblas-dev \
      ffmpeg unzip libbz2-dev python3-venv \
      python3.10 python3.10-venv python3.10-dev \
      g++ gcc gfortran make gdb strace wget ca-certificates --no-install-recommends
  
  #removing python3-numpy because it is version 1 and replacing it with pip3 numpy which is version 2.1.3 needed to qiskit-aer-gpu
  apt install -y rocm-libs rccl 
  apt install -y build-essential
  pip3 install --upgrade pip
  # needed to fix an ibm dependency
  pip3 install "urllib3>=2.1.0,<3.0.0"
  # needed to fix issues with qiskit-aer being built using a lower version of numpy and then qiskit-aer-gpu upgrading numpy in whl file
  pip3 install --ignore-installed qiskit==1.2.4 numpy==2.1.3
  # Install packages needed for qiskit
  pip3 install "pybind11[global]>=2.12"
  pip3 install -r /opt/requirements.txt

  # Download MPICH and unpack - moving from 3.1.4 to 3.2.1 to address a stack overflow bug
  # https://github.com/pmodels/mpich/issues/2317
  MPICH_VERSION="3.2.1"
  cd /opt
  wget https://www.mpich.org/static/downloads/${MPICH_VERSION}/mpich-${MPICH_VERSION}.tar.gz
  tar xf mpich-${MPICH_VERSION}.tar.gz
  rm mpich-${MPICH_VERSION}.tar.gz
  cd mpich-${MPICH_VERSION}

  # must be done before configure - Resolving Fortran compiler gfortran not allowing mismatched arguments in routine calls with exporting these flags
  export FCFLAGS="-fallow-argument-mismatch"
  export FFLAGS="-fallow-argument-mismatch"
  export CXXFLAGS="-Wno-type-safety"

  # Run configure with the environment variables - removed switch that disables fortran for mpich
  ./configure --enable-fast=all,O3 --prefix=/usr FCFLAGS="$FCFLAGS" FFLAGS="$FFLAGS" CXXFLAGS="$CXXFLAGS"
  
  # Build and install MPICH
  make -j$(nproc)
  make install
  ldconfig
  cd /opt
  rm -rf mpich-${MPICH_VERSION}

  # Install aws-ofi-rccl dependancies 
  apt install -y libfabric-dev automake

  # Clone and build aws-ofi-rccl that has latest changes from October 18 2024 (git commit 17d41cb)
  # To find the commits, we do the following
  # git clone https://github.com/ROCmSoftwarePlatform/aws-ofi-rccl
  # cd aws-ofi-rccl/
  # git fetch --all
  # git log --graph --oneline --all
  cd /opt
  git clone --depth 1 https://github.com/ROCmSoftwarePlatform/aws-ofi-rccl
  cd aws-ofi-rccl
  git fetch --all
  git checkout 17d41cb
  ./autogen.sh
  ./configure
  make -j$(nproc)
  make install

  # Update library path
  export LD_LIBRARY_PATH=/usr/local/lib:$LD_LIBRARY_PATH
  
  # Clean up
  cd /opt
  rm -rf aws-ofi-rccl

  # Build qiskit-aer-gpu from source
  # Entering into a python3 venv to build qiskit-aer-gpu-rocm without using python3-numpy because it causes pip3 module numpy issues when running simulations
  cd /opt
  python3.10 -m venv myenv
  . myenv/bin/activate
  # Ensure the virtual environment packages are prioritized
  export LD_LIBRARY_PATH=/usr/local/lib:$LD_LIBRARY_PATH
  export PYTHONPATH=$(pwd)/myenv/lib/python3.10/site-packages:$PYTHONPATH
  # Install pip modules that may be needed to building qiskit-aer-gpu
  pip3 install --ignore-installed numpy==2.1.3
  pip3 install --no-cache-dir -r /opt/requirements.txt
  pip3 install --no-cache-dir -r /opt/requirements-dev.txt
  
  # Clone the qiskit-aer-gpu-rocm repository - using stable branch/0.15 newer versions may cause unknown issues if we need to rebuild the container, this helps prevent chaos
  git clone -b stable/0.15 https://github.com/Qiskit/qiskit-aer
  cd qiskit-aer/
  
  QISKIT_AER_PACKAGE_NAME='qiskit-aer-gpu-rocm' \
    python3 ./setup.py bdist_wheel -- \
      -DAER_THRUST_BACKEND=ROCM \
      -DAER_MPI=ON \
      -DAER_ROCM_ARCH='gfx90a'
  
  # changed switch from --forec-reinstall to --upgrade-strategy only-if-needed  because this pip install was upgrading everything in the whl to latest versions
  # Leave Python3 venv used for building qiskit-aer-gpu-rocm so that we can install the qiskit_aer_gpu_rocm-*.whl outside of pythong venv
  deactivate

  # installing qiskit_aer_gpu_rocm-*.whl software into system
  pip3 install --force-reinstall  /opt/qiskit-aer/dist/qiskit_aer_gpu_rocm-*.whl
  # pip3 install --force-reinstall --upgrade-strategy only-if-needed dist/qiskit_aer_gpu_rocm-*.whl

  apt clean


%environment
  export LC_ALL=C
  export LD_LIBRARY_PATH=/usr/local/lib:$LD_LIBRARY_PATH
  export DAER_ROCM_ARCH=gfx90a
