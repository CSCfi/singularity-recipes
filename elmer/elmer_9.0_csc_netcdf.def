Bootstrap: library
From: centos:7.7

%labels
  Author Thomas Zwinger <thomas.zwinger@csc.fi>

%files
  Makefile.inc /opt/Makefile.inc

%post
  # Upgrade packages to most recent versions
  yum -y upgrade

  # Enable EPEL (required by NVIDIA packages)
  yum -y install https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm

  # Install newer gcc 
  yum -y install centos-release-scl
  yum -y install devtoolset-9
  yum -y install rh-git218
  yum -y remove cmake
  yum -y install cmake3
  source /opt/rh/devtoolset-9/enable
  source /opt/rh/rh-git218/enable

  # Install additional stuff
  yum -y install wget cmake lbzip2 libsndfile numactl

  # Install Mellanox stuff and OpenMPI
  wget https://www.mellanox.com/downloads/ofed/RPM-GPG-KEY-Mellanox
  rpm --import RPM-GPG-KEY-Mellanox
  rm RPM-GPG-KEY-Mellanox

  cd /etc/yum.repos.d/

  # MOFED 5.5 (needed by RHEL8)
  wget https://linux.mellanox.com/public/repo/mlnx_ofed/5.5-1.0.3.2/rhel7.8/mellanox_mlnx_ofed.repo
  yum -y install mlnx-ofed-all

  export OMPI_DIR=$(ls -1d /usr/mpi/gcc/openmpi-4.1.* | head -n1)
  export PATH=$OMPI_DIR/bin:$PATH
  export LD_LIBRARY_PATH=$OMPI_DIR/lib64:$LD_LIBRARY_PATH
  export MPI_C_LIBRARIES=$OMPI_DIR/lib64/libmpi.so
  export MPI_C_INCLUDE_PATH=$OMPI_DIR/include
  export MPI_C_COMPILER=$OMPI_DIR/bin/mpicc 
  export MPI_Fortran_COMPILER=$OMPI_DIR/bin/mpif90
  export MPI_CXX_COMPILER=$OMPI_DIR/bin/mpicxx

  # additionally needed libraries
  yum -y install openblas-devel 
  yum -y install m4
  yum -y install curl-devel
  yum clean all

  which gcc
  which mpicc
  which gfortran
  which mpif90
  mpicc --showall
  mpif90 --showall

  # compiling libraries
  mkdir  /opt/src
  cd /opt/src

  # compile/install netcdf
  git clone https://github.com/Unidata/netcdf-c.git
  cd netcdf-c
  mkdir build 
  cd build/
  cmake3 -DCMAKE_INSTALL_PREFIX=/opt/netcdf  -DCMAKE_C_FLAGS="-O3 -fopenmp" -DENABLE_HDF5:BOOL=FALSE ..
  make -j $(nproc)
  make install
  export LD_LIBRARY_PATH="/opt/netcdf/lib64:$LD_LIBRARY_PATH"
  cd /opt/src
  git clone --depth 1 --branch v4.5.2 https://github.com/Unidata/netcdf-fortran
  cd netcdf-fortran/
  mkdir build
  cd build/
  cmake3 -DCMAKE_INSTALL_PREFIX=/opt/netcdf  -DCMAKE_Fortran_FLAGS="-O3 -fopenmp" -DCMAKE_C_FLAGS="-O3 -fopenmp"  ..
  make -j  $(nproc)
  make install
  cd /opt/src
  rm -fr netcdf-c netcdf-fortran
  

 # and, finally, Elmer
  cd /opt/src
  git clone https://github.com/ElmerCSC/elmerfem.git
  cd elmerfem
  git submodule update --init
  mkdir build
  cd build
  cmake3 ../ -DCMAKE_INSTALL_PREFIX=/opt/elmer \
           -DWITH_MPI:BOOL=TRUE \
           -DWITH_LUA:BOOL=TRUE \
           -DWITH_OpenMP:BOOL=TRUE \
	   -DWITH_ElmerIce:BOOL=TRUE \
	   -DWITH_NETCDF:BOOL=TRUE \
           -DWITH_GridDataReader:BOOL=TRUE \
           -DNetCDF_INCLUDE_DIR="/opt/netcdf/include" \
           -DNetCDF_LIBRARY="/opt/netcdf/lib64/libnetcdf.so" \
           -DNetCDFF_LIBRARY="/opt/netcdf/lib64/libnetcdff.so" \
 	   -DWITH_Zoltan:BOOL=TRUE   

  make -j $(nproc) install
  cd /opt/src
  rm -fr elmerfem 	

%environment
  export SLURM_MPI_TYPE=pmix_v3
  export PMIX_MCA_gds=hash
  source /opt/rh/devtoolset-9/enable
  source /opt/rh/rh-git218/enable
  export OMPI_DIR=$(ls -1d /usr/mpi/gcc/openmpi-4.1.* | head -n1)
  export PATH=$OMPI_DIR/bin:/opt/elmer/bin:$PATH
  export LD_LIBRARY_PATH=$OMPI_DIR/lib64:$LD_LIBRARY_PATH
  export MPI_C_LIBRARIES=$OMPI_DIR/lib64/libmpi.so
  export MPI_C_INCLUDE_PATH=$OMPI_DIR/include
  export MPI_C_COMPILER=$OMPI_DIR/bin/mpicc 
  export MPI_Fortran_COMPILER=$OMPI_DIR/bin/mpif90
  export MPI_CXX_COMPILER=$OMPI_DIR/bin/mpicxx
 



